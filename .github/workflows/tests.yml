name: Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  DB_CONNECTION: mysql
  DB_HOST: 127.0.0.1
  DB_PORT: 3306
  DB_DATABASE: laravel
  DB_USERNAME: root
  DB_PASSWORD: root

jobs:
  tests:
    strategy:
      fail-fast: true
      matrix:
        shard: [1, 2, 3, 4]
        php: [8.4]

    name: Application Tests (Shard ${{ matrix.shard }}/4)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ‘€ Checkout
        uses: actions/checkout@v6

      - name: ğŸª„ Setup Environment
        uses: ./.github/actions/setup
        with:
          php-version: ${{ matrix.php }}
          cache-suffix: shard-${{ matrix.shard }}

      - name: Rector Cache
        uses: actions/cache@v5
        with:
          path: storage/rector
          key: ${{ runner.os }}-rector-${{ hashFiles('composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-rector-

      - name: ğŸ—„ï¸ Setup Database
        uses: ./.github/actions/setup-mysql

      - name: ğŸ“Š Run Type Coverage
        run: composer test:type

      - name: ğŸ§ª Run Tests (Shard ${{ matrix.shard }}/4)
        run: php artisan test --shard ${{ matrix.shard }}/4 --ci -p

  browser:
    name: Browser Tests
    runs-on: ubuntu-latest
    needs: tests

    steps:
      - name: ğŸ‘€ Checkout
        uses: actions/checkout@v6

      - name: ğŸª„ Setup Environment
        uses: ./.github/actions/setup
        with:
          php-version: 8.4
          cache-suffix: browser

      - name: ğŸ­ Setup Playwright
        uses: ./.github/actions/setup-playwright

      - name: ğŸ—„ï¸ Setup Database
        uses: ./.github/actions/setup-mysql

      - name: ğŸ§ª Run Browser Tests
        run: ./vendor/bin/pest --group=browser --ci

      - name: Store Artifacts (Browser Screenshots)
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: browser-screenshots
          path: |
            tests/Browser/Screenshots
          if-no-files-found: ignore
